<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>PL/0 present by sPARks</title>
</head>

<body style="display: flex; flex-direction: row; gap: 10px;height: 100vh;
box-sizing: border-box;
margin: 0px; padding: 2px 10px 10px 10px;">

	<div
		style="overflow: hidden; height: 100%;width: 40%; min-width: 20%; max-width: 80%; resize: horizontal;  font-family: consolas; display: flex;flex-direction: column; gap: 10px">
		<h3 style="margin: 0px 12px; margin-top: 8px;font-family: consolas;">Coder</h3>
		<textarea style="height: 70%;width: 100%;resize: vertical;  font-family: consolas; " id="input"># sPARks PL/0 Hello World !!
var a : int[3], b : int = a[1] + "";.
</textarea>
		<div style="display: flex;flex-direction: row; justify-content: space-between; padding-right: 12px;">
			<h3 style="margin: 0px 12px;font-family: consolas;">SSIR</h3>
			<button onclick="test()" style="font-family: consolas;">Run Code</button>
		</div>
		<pre style="flex:1;background-color: rgb(0, 0, 0); padding: 10px; margin: 0px; word-break: break-all; font-size: 12px; font-family: consolas; overflow-y: auto; color: white; box-sizing: border-box;"
			id="count"></pre>
		<h3 style="margin: 0px 12px;font-family: consolas;">Output</h3>
		<pre style="background-color: rgb(0, 0, 0); padding: 10px; margin: 0px; word-break: break-all; font-size: 12px; font-family: consolas; overflow-y: auto; color: white; box-sizing: border-box;"
			id="console"></pre>
	</div>
	<div
		style="overflow: hidden; height: 100%;width: 300px; min-width: 5%; max-width: 80%; resize: horizontal;  font-family: consolas; display: flex;flex-direction: column; gap: 10px">
		<h3 style="margin: 0px 12px; margin-top: 8px;font-family: consolas;">Lexer</h3>
		<pre style="flex:1;width:100%; background-color: rgb(0, 0, 0); padding: 10px; margin: 0px; word-break: break-all; font-size: 12px; color: white; font-family: consolas; overflow: auto; box-sizing: border-box;"
			id="tokens"></pre>
	</div>
	<div
		style="overflow: hidden; height: 100%;width: 500px; min-width: 5%; max-width: 80%; resize: horizontal;  font-family: consolas; display: flex;flex-direction: column; gap: 10px; box-sizing: border-box;">
		<h3 style="margin: 0px 12px; margin-top: 8px;font-family: consolas;">Parser</h3>
		<pre style="flex:1;width:100%; background-color: rgb(0, 0, 0); padding: 10px; margin: 0px; word-break: break-all; font-size: 12px; color: white; font-family: consolas; overflow: auto; box-sizing: border-box;"
			id="parser"></pre>
	</div>
	<div
		style="overflow: hidden; height: 100%;flex:1; min-width: 5%; max-width: 80%; font-family: consolas; display: flex;flex-direction: column; gap: 10px">
		<h3 style="margin: 0px 12px; margin-top: 8px;font-family: consolas;">AST</h3>
		<pre style="flex:1;width:100%; background-color: rgb(0, 0, 0); padding: 10px; margin: 0px; word-break: break-all; font-size: 12px; color: white; font-family: consolas; overflow: auto; box-sizing: border-box;"
			id="ast"></pre>
	</div>
	<!-- <pre style="flex: 1; width: 100%; background-color: rgb(0, 0, 0); padding: 10px; margin: 0px; word-break: break-all; font-size: 12px; color: white; font-family: consolas;"
		id="parser"></pre>
	<pre style="flex:1; width: 100px; background-color: rgb(0, 0, 0); padding: 10px; margin: 0px; word-break: break-all; font-size: 12px; color: white; font-family: consolas; overflow-y: auto;"
		id="ast"></pre> -->
</body>
<script src="lib/codemirror.js"></script>
<link rel="stylesheet" href="lib/codemirror.css">
<style>
	.CodeMirror {
		font-family: consolas;
		font-size: 16px;
	}
</style>
<script type="module">
	import * as SUN from './sunLang.js';
	var myCodeMirror = CodeMirror.fromTextArea(document.getElementById('input'), {
		lineNumbers: true,
		mode: "javascript"
	});

	myCodeMirror.on('change', (cm, obj) => {
		window.input(cm.getValue())
	})
	// import * as Data from './demo.sun';

	let PL0 = SUN.PL0();
	// console.log(PL0)
	// PL0.print();

	window.test = function () {
		let str = eval(document.getElementById('count').innerText)
		document.getElementById("console").innerHTML = str.split("\n").filter((s) => s !== '').map((s) => `<a style="color: rgb(0,255,0);">${">> "}</a>${s}`).join("\n")
	}

	window.input = function (val) {
		console.clear()
		let source = new SUN.SourceScript(val, "terminal");

		let lexer = new SUN.Lexer(source);
		lexer.tokenize();

		let ans = []
		lexer.errors.forEach(e => {
			let [s, starter, _] = source.get_ScriptPortion(e.start, e.end, '^', "red")
			ans.push(s + `${starter}<a style="color: red;">${e.type} ${e.message}</a>\n`);
			// ans.push(e.type + ' : ' + e.message + "\n" + source.get_ScriptPortion(e.start, e.end, '^', 'red')[0]);
		})

		console.log(lexer.tokens)

		lexer.tokens.forEach(t => {
			ans.push(source.get_ScriptPortion(t.start, t.end, undefined, "rgb(0,255,0)", false)[0] + ` (${t.type}, '${t.value}')` + '\n');
		})

		document.getElementById('tokens').innerHTML = ans.join('')

		ans = []

		let ast = PL0.match(lexer.tokens);
		console.log(ast);

		if (ast[3] !== undefined) {
			let err = ast[3];
			while (err !== undefined) {
				let [s, starter, _] = source.get_ScriptPortion(err.start, err.end, '^', "red")
				ans.push(s + `${starter}<a style="color: red;">${err.type}\n${err.message.split('\n').map(i => `<a style="color: white;">${starter}</a>` + `${i}`).join('\n')}</a>\n`);
				err = err.last
			}
			document.getElementById('parser').innerHTML = ans.join('\n')
			document.getElementById('count').innerText = "no code translated"
			document.getElementById('ast').innerText = 'Error !'
		}
		else {
			document.getElementById('parser').innerHTML = '<a style="color: rgb(0,255,0);">OK</a>'
			if (ast[2] !== undefined) {
				let walker = new SUN.Walker(ast[2][1], SUN.PL0Visitors, lexer.tokens, source);
				let [astnew, err] = walker.walk();
				// console.log(err)
				let ans = []
				err.forEach((err) => {
					console.log(err);
					let [s, starter] = source.get_ScriptPortion(err.start, err.end, '^', "red")
					ans.push(s + `${starter}<a style="color: red;">${err.type}\n${err.message.split('\n').map(i => `<a style="color: white;">${starter}</a>` + `${i}`).join('\n')}</a>\n`);
				})

				// console.log(ans)
				if (ans.length > 0) {
					document.getElementById('parser').innerHTML = ans.join('\n')
				}
				// document.getElementById('ast').innerText = JSON.stringify(astnew, null, 2)
				document.getElementById('ast').innerText = JSON.stringify(ast[2][1], null, 2)
			}
			else
				document.getElementById('ast').innerText = 'Error !'
			let jsc = new SUN.SSIRConverter(ast[2][1])
			jsc.convert()
			ans = []
			if (jsc.errors.length > 0) {
				jsc.errors.forEach((err) => {
					let [s, starter] = source.get_ScriptPortion(err.start, err.end, '^', "red")
					ans.push(s + `<a style="color: red;">${err.message.split('\n').map(i => `<a style="color: white;">${starter}</a>` + `<a style="color: red;">${i}</a>`).join('\n')}</a>\n`);
				})
				document.getElementById('count').innerHTML = ans.join('')
			}
			else
				document.getElementById('count').innerText = "// Translated by sun sPARks" + '\n' + jsc.target
		}

	}

	// 	window.input(`# sPARks PL/0 Hello World !!
	// # 在这里键入PL/0 程序
	// var n, i, j, c, sum;

	// procedure fact;
	//   begin
	//     c := 1;
	//     j := 1;
	//     while j <=i do
	//       begin
	//         c := c*j;
	//         j := j+1;
	//       end
	//   end
	// ;

	// begin
	//   sum := 0;
	//   read(n);
	//   i := 1;
	//   while i <= n do
	//     begin
	//       call fact;
	//       sum := sum+c;
	//       i := i+1;
	//     end;
	//   write(sum);
	// end.`)

	// SUN.SPARK_print();
	// console.log(SUN.SPARK_get_First());
	// console.log(SUN.SPARK_get_Empty());
	let text = (`4 : 29 : 29
15 : 95 : 95
15 : 96 : 191
10 : 65 : 65
10 : 66 : 131
13 : 83 : 83
13 : 84 : 167
7 : 47 : 47
7 : 48 : 95
7 : 49 : 144
7 : 50 : 194
7 : 51 : 245
7 : 52 : 297
15 : 97 : 288
15 : 98 : 386
15 : 99 : 485
15 : 100 : 585
10 : 67 : 198
10 : 68 : 266
10 : 69 : 335
10 : 70 : 405
13 : 85 : 252
13 : 86 : 338
13 : 87 : 425
13 : 88 : 513
11 : 71 : 71
11 : 72 : 143
11 : 73 : 216
11 : 74 : 290
11 : 75 : 365
11 : 76 : 441
2 : 15 : 15
2 : 16 : 31
2 : 17 : 48
9 : 59 : 59
9 : 60 : 119
9 : 61 : 180
9 : 62 : 242
9 : 63 : 305
9 : 64 : 369
12 : 77 : 77
12 : 78 : 155
12 : 79 : 234
12 : 80 : 314
2 : 18 : 66
2 : 19 : 85
2 : 20 : 105
2 : 21 : 126
0 : 1 : 1
0 : 2 : 3
0 : 3 : 6
0 : 4 : 10
0 : 5 : 15
0 : 6 : 21
0 : 7 : 28
4 : 30 : 59
4 : 31 : 90
4 : 32 : 122
4 : 33 : 155
4 : 34 : 189
1 : 8 : 8
1 : 9 : 17
6 : 41 : 41
6 : 42 : 83
6 : 43 : 126
6 : 44 : 170
6 : 45 : 215
6 : 46 : 261
1 : 10 : 27
8 : 53 : 53
8 : 54 : 107
8 : 55 : 162
8 : 56 : 218
8 : 57 : 275
8 : 58 : 333
5 : 35 : 35
5 : 36 : 71
14 : 89 : 89
14 : 90 : 179
14 : 91 : 270
14 : 92 : 362
14 : 93 : 455
14 : 94 : 549
1 : 11 : 38
1 : 12 : 50
1 : 13 : 63
1 : 14 : 77
3 : 22 : 22
3 : 23 : 45
3 : 24 : 69
3 : 25 : 94
3 : 26 : 120
3 : 27 : 147
3 : 28 : 175
5 : 37 : 108
5 : 38 : 146
5 : 39 : 185
5 : 40 : 225
12 : 81 : 395
12 : 82 : 477`).split('\n').map((s) => { return s.split(" : ") })
	text.sort((a, b) => {
		return a[0] - b[0]
	})
	console.log(text)
</script>

</html>